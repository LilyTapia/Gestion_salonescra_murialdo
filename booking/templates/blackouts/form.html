{% extends "base.html" %}
{% block content %}
<div class="form-container">
  <h2>{{ title }}</h2>

  <form method="post" class="block-form">
    {% csrf_token %}

    <div class="form-section">
      <h3>Información del bloqueo</h3>

      <div class="form-group">
        <label for="{{ form.room.id_for_label }}">Salón</label>
        {{ form.room }}
        {% if form.room.errors %}
          <div class="error-messages">
            {% for error in form.room.errors %}
              <p class="error">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
        <small class="help-text">Deja vacío para bloqueo global</small>
      </div>

      <div class="form-group">
        <label for="{{ form.date.id_for_label }}">Fecha</label>
        {{ form.date }}
        {% if form.date.errors %}
          <div class="error-messages">
            {% for error in form.date.errors %}
              <p class="error">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
        <small class="help-text">Elige la fecha para cargar los horarios disponibles del día para bloquear.</small>
      </div>

      <div class="form-group">
        <label for="block-select"><strong>Bloque</strong></label>
        <select id="block-select" class="filter-select" required></select>
        <small id="block-help" class="help-text"></small>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.start_time.id_for_label }}">Inicio</label>
          {{ form.start_time }}
          {% if form.start_time.errors %}
            <div class="error-messages">
              {% for error in form.start_time.errors %}
                <p class="error">{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.end_time.id_for_label }}">Término</label>
          {{ form.end_time }}
          {% if form.end_time.errors %}
            <div class="error-messages">
              {% for error in form.end_time.errors %}
                <p class="error">{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    {% if not form.repeat.is_hidden %}
    <div class="form-section">
      <h3>Repetición</h3>
      <div class="form-group">
        <label for="{{ form.repeat.id_for_label }}">Frecuencia</label>
        {{ form.repeat }}
        {% if form.repeat.errors %}
          <div class="error-messages">
            {% for error in form.repeat.errors %}
              <p class="error">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      <div class="form-group" id="repeat-until-wrapper">
        <label for="{{ form.repeat_until.id_for_label }}">Repetir hasta</label>
        {{ form.repeat_until }}
        <small class="help-text">{{ form.repeat_until.help_text }}</small>
        {% if form.repeat_until.errors %}
          <div class="error-messages">
            {% for error in form.repeat_until.errors %}
              <p class="error">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    {% else %}
      {{ form.repeat }}
      {{ form.repeat_until }}
    {% endif %}

    <div class="form-section">
      <h3>Detalle</h3>
      <div class="form-group">
        <label for="{{ form.reason.id_for_label }}">Razón</label>
        {{ form.reason }}
        {% if form.reason.errors %}
          <div class="error-messages">
            {% for error in form.reason.errors %}
              <p class="error">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    {% if form.non_field_errors %}
      <div class="error-messages">
        {% for error in form.non_field_errors %}
          <p class="error">{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a href="{% url 'blackout_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<style>
.form-container {
  max-width: 720px;
  margin: 2rem auto;
  padding: 2.5rem;
  border: 1px solid #ddd;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
}

.form-container h2 {
  text-align: left;
  margin-bottom: 1.5rem;
  font-size: 1.75rem;
  color: #2c3e50;
}

.block-form {
  display: flex;
  flex-direction: column;
  gap: 1.75rem;
}

.form-section {
  padding: 1.5rem;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  background: #f9fbfd;
}

.form-section h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 1.2rem;
  color: #1d3b58;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.form-row {
  display: flex;
  gap: 1.5rem;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  margin-bottom: 0;
}

.form-group label {
  font-weight: 600;
  color: #34495e;
}

.form-group select,
.form-group input,
.form-group textarea {
  padding: 0.75rem;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: 1rem;
  background: #fff;
}

.filter-select {
  width: 100%;
}

.form-group select:focus,
.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

.help-text {
  font-size: 0.85rem;
  color: #6c757d;
}

.error-messages {
  margin-top: 0.25rem;
}

.error {
  color: #dc3545;
  font-size: 0.85rem;
  margin: 0.1rem 0;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
}

.btn {
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 6px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.btn-primary {
  background-color: #2563eb;
  color: #fff;
}

.btn-primary:hover {
  background-color: #1d4ed8;
}

.btn-secondary {
  background-color: #6c757d;
  color: #fff;
}

.btn-secondary:hover {
  background-color: #545b62;
}

@media (max-width: 640px) {
  .form-container {
    padding: 1.5rem;
  }
  .form-row {
    flex-direction: column;
  }
}
</style>

<script>
  const BLOQUES_BASE = [
    ["08:00","08:45"],
    ["08:45","09:30"],
    ["09:50","10:35"],
    ["10:35","11:20"],
    ["11:35","12:20"],
    ["12:20","13:05"],
    ["13:05","13:50"],
    ["13:50","14:35"],
    ["14:35","15:20"],
    ["15:20","16:05"],
    ["16:05","16:50"],
  ];

  const SCHEDULE = {
    1: BLOQUES_BASE,
    2: BLOQUES_BASE,
    3: BLOQUES_BASE,
    4: [...BLOQUES_BASE, ["17:00","18:00"]],
    5: BLOQUES_BASE.slice(0, 6),
  };

  const ALL_DAY_VALUE = 'ALL_DAY';

  function parseISO(str){ const [y,m,d]=str.split('-').map(Number); return new Date(y, m-1, d); }
  function weekday(str){ return str ? parseISO(str).getDay() : null; }

  const dateInput   = document.getElementById('id_date');
  const startInput  = document.getElementById('id_start_time');
  const endInput    = document.getElementById('id_end_time');
  const blockSelect = document.getElementById('block-select');
  const blockHelp   = document.getElementById('block-help');
  const repeatField = document.getElementById('id_repeat');
  const repeatUntil = document.getElementById('id_repeat_until');
  const repeatWrapper = document.getElementById('repeat-until-wrapper');

  [startInput, endInput].forEach(i => { if (i) i.readOnly = true; });

  function scheduleFor(dayIdx){
    return SCHEDULE[dayIdx] || null;
  }

  function setTimes(dayIdx, value){
    const daySchedule = scheduleFor(dayIdx);
    if (!daySchedule){ return; }

    if (value === ALL_DAY_VALUE){
      const firstStart = daySchedule[0][0];
      const lastEnd = daySchedule[daySchedule.length - 1][1];
      startInput.value = firstStart;
      endInput.value = lastEnd;
      blockHelp.textContent = `Bloqueo completo del día: ${firstStart} - ${lastEnd}`;
      return;
    }

    const idx = Number(value);
    const [ini, fin] = daySchedule[idx];
    startInput.value = ini;
    endInput.value   = fin;
    blockHelp.textContent = `Horario del bloque ${idx + 1}: ${ini} - ${fin}`;
  }

  function syncBlockFromTimes(dayIdx){
    const daySchedule = scheduleFor(dayIdx);
    if (!startInput || !endInput || !startInput.value || !endInput.value || !daySchedule){
      return false;
    }
    const firstStart = daySchedule[0][0];
    const lastEnd = daySchedule[daySchedule.length - 1][1];
    if (startInput.value === firstStart && endInput.value === lastEnd){
      blockSelect.value = ALL_DAY_VALUE;
      blockHelp.textContent = `Bloqueo completo del día: ${firstStart} - ${lastEnd}`;
      return true;
    }
    const idx = daySchedule.findIndex(([ini, fin]) => ini === startInput.value && fin === endInput.value);
    if (idx >= 0){
      blockSelect.value = String(idx);
      setTimes(dayIdx, String(idx));
      return true;
    }
    return false;
  }

  function loadBlocksFor(dayIdx){

    blockSelect.innerHTML = '';

    const daySchedule = scheduleFor(dayIdx);

    if (!daySchedule){

      blockSelect.add(new Option('Selecciona un día hábil', '', true, true));

      blockSelect.disabled = true;

      if (startInput) startInput.value = '';

      if (endInput) endInput.value = '';

      blockHelp.textContent = 'Solo hay bloques entre lunes y viernes.';

      return;

    }

    blockSelect.disabled = false;

    blockSelect.add(new Option('Bloquear todo el día', ALL_DAY_VALUE));

    daySchedule.forEach((range, i) => {

      blockSelect.add(new Option(`Bloque ${i + 1}`, String(i)));

    });



    if (!syncBlockFromTimes(dayIdx)){

      blockSelect.value = ALL_DAY_VALUE;

      setTimes(dayIdx, ALL_DAY_VALUE);

    }

  }





  if (dateInput){
    dateInput.addEventListener('change', () => {
      const d = weekday(dateInput.value);
      loadBlocksFor(d);
    });
    if (dateInput.value){
      loadBlocksFor(weekday(dateInput.value));
    } else {
      blockSelect.add(new Option('Selecciona una fecha primero', '', true, true));
      blockSelect.disabled = true;
    }
  }

  blockSelect.addEventListener('change', () => {
    const d = weekday(dateInput.value);
    if (!scheduleFor(d)){ return; }
    setTimes(d, blockSelect.value);
  });

  if (repeatField && repeatWrapper){
    function toggleRepeatUntil(){
      const shouldShow = repeatField.value && repeatField.value !== 'none';
      repeatWrapper.style.display = shouldShow ? 'flex' : 'none';
      if (!shouldShow && repeatUntil){ repeatUntil.value = ''; }
    }
    toggleRepeatUntil();
    repeatField.addEventListener('change', toggleRepeatUntil);
  }
</script>
{% endblock %}



